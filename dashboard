import React, { useState, useEffect } from 'react';
import { 
  LayoutDashboard, 
  ShoppingBag, 
  TrendingUp, 
  TrendingDown, 
  Package, 
  Plus, 
  Trash2, 
  Save, 
  ShoppingCart,
  DollarSign,
  Lightbulb,
  BarChart3,
  ArrowUpRight,
  ArrowDownRight,
  Calendar,
  User,
  Trophy,
  History,
  Loader2
} from 'lucide-react';
import { 
  AreaChart, 
  Area, 
  XAxis, 
  YAxis, 
  CartesianGrid, 
  Tooltip, 
  Legend, 
  ResponsiveContainer
} from 'recharts';

// --- FIREBASE IMPORTS ---
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, onSnapshot, addDoc, deleteDoc, doc } from 'firebase/firestore';

const FinancialManagerDark = () => {
  // --- CONFIGURAÇÃO FIREBASE ---
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [db, setDb] = useState(null);
  
  // --- ESTADOS DA UI ---
  const [view, setView] = useState('dashboard'); 
  const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
  
  // --- ESTADOS DE DADOS ---
  const [products, setProducts] = useState([]);
  const [transactions, setTransactions] = useState([]);

  // --- FORMULÁRIOS ---
  // Alterei os valores iniciais para string para facilitar a digitação de vírgulas
  const [newProd, setNewProd] = useState({ name: '', merchCost: '', prodCost: '', price: '', stock: '' });
  const [cart, setCart] = useState([]); 
  const [cartItem, setCartItem] = useState({ productId: '', quantity: 1 }); 
  const [customerName, setCustomerName] = useState('');
  const [saleDate, setSaleDate] = useState(new Date().toISOString().split('T')[0]); 
  const [expenseForm, setExpenseForm] = useState({ description: '', amount: '', category: 'Reposição de estoque', date: new Date().toISOString().split('T')[0] });

  // --- HELPERS DE CORREÇÃO (NOVO) ---
  
  // 1. Corrige problema de fuso horário extraindo dados diretamente da string YYYY-MM-DD
  const getDateParts = (dateString) => {
    if (!dateString) return { year: 0, month: -1 };
    const parts = dateString.split('-'); // ['2023', '11', '01']
    return {
      year: parseInt(parts[0], 10),
      month: parseInt(parts[1], 10) - 1 // Mês 0-11
    };
  };

  // 2. Corrige problema de R$ convertendo vírgula para ponto
  const parseCurrencyInput = (value) => {
    if (typeof value === 'number') return value;
    if (!value) return 0;
    // Substitui vírgula por ponto e remove caracteres não numéricos exceto ponto
    return parseFloat(value.toString().replace(',', '.'));
  };

  const formatCurrency = (val) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(Number(val));

  // --- INICIALIZAÇÃO FIREBASE ---
  useEffect(() => {
    const initApp = async () => {
      if (typeof __firebase_config === 'undefined') return;
      
      try {
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const firestore = getFirestore(app);
        setDb(firestore);

        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }

        const unsubscribe = onAuthStateChanged(auth, (u) => {
          setUser(u);
          if (!u) setLoading(false);
        });
        return unsubscribe;
      } catch (err) {
        console.error("Erro ao inicializar Firebase:", err);
        setLoading(false);
      }
    };

    initApp();
  }, []);

  // --- ESCUTAR DADOS ---
  useEffect(() => {
    if (!user || !db) return;

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';
    
    // Referências
    const productsRef = collection(db, 'artifacts', appId, 'users', user.uid, 'products');
    const transactionsRef = collection(db, 'artifacts', appId, 'users', user.uid, 'transactions');

    // Listener Produtos
    const unsubProducts = onSnapshot(productsRef, (snapshot) => {
      const prodList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setProducts(prodList);
    }, (error) => console.error("Erro ao buscar produtos:", error));

    // Listener Transações
    const unsubTransactions = onSnapshot(transactionsRef, (snapshot) => {
      const transList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      transList.sort((a, b) => new Date(b.date) - new Date(a.date));
      setTransactions(transList);
      setLoading(false);
    }, (error) => {
        console.error("Erro ao buscar transações:", error);
        setLoading(false);
    });

    return () => {
      unsubProducts();
      unsubTransactions();
    };
  }, [user, db]);

  // Identificar anos disponíveis (usando a correção de data)
  const availableYears = Array.from(new Set([
    new Date().getFullYear(),
    ...transactions.map(t => getDateParts(t.date).year)
  ])).sort((a, b) => b - a);

  // --- FUNÇÕES CRUD (FIREBASE) ---

  const handleAddProduct = async (e) => {
    e.preventDefault();
    if (!user || !db) return;

    // Usando o helper para garantir que vírgulas virem pontos
    const merch = parseCurrencyInput(newProd.merchCost);
    const prod = parseCurrencyInput(newProd.prodCost);
    const price = parseCurrencyInput(newProd.price);
    const stock = parseCurrencyInput(newProd.stock);
    const total = merch + prod;
    
    if (isNaN(price)) {
        alert("Por favor, verifique os valores inseridos.");
        return;
    }

    const productData = {
      name: newProd.name,
      merchCost: merch,
      prodCost: prod,
      totalCost: total,
      price: price,
      stock: stock,
      createdAt: new Date().toISOString()
    };

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';
    
    try {
        await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'products'), productData);
        // Limpar formulário
        setNewProd({ name: '', merchCost: '', prodCost: '', price: '', stock: '' });
        alert("Produto cadastrado com sucesso!");
    } catch (error) {
        console.error("Erro ao salvar produto:", error);
        alert("Erro ao salvar. Tente novamente.");
    }
  };

  const deleteProduct = async (id) => {
    if (!user || !db) return;
    if (!window.confirm("Tem certeza que deseja excluir este produto?")) return;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';
    await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'products', id));
  };

  // --- LÓGICA DE VENDAS ---
  const addToCart = () => {
    if (!cartItem.productId) return;
    const product = products.find(p => p.id === cartItem.productId);
    if (!product) return;
    
    const newItem = {
      productId: product.id,
      name: product.name,
      price: product.price,
      cost: product.totalCost, 
      quantity: Number(cartItem.quantity),
      total: Number(cartItem.quantity) * product.price
    };

    setCart([...cart, newItem]);
    setCartItem({ productId: '', quantity: 1 });
  };

  const finalizeSale = async () => {
    if (cart.length === 0 || !user || !db) return;
    
    const totalAmount = cart.reduce((acc, item) => acc + item.total, 0);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';

    const transactionData = {
      type: 'income',
      date: saleDate, // YYYY-MM-DD
      amount: totalAmount,
      items: cart,
      description: customerName || `Cliente Anônimo`,
      createdAt: new Date().toISOString()
    };

    try {
        await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'transactions'), transactionData);
        setCart([]);
        setCustomerName('');
        alert("Venda registrada!");
    } catch (error) {
        console.error("Erro ao registrar venda:", error);
    }
  };

  const addExpense = async (e) => {
    e.preventDefault();
    if (!user || !db) return;

    const amountVal = parseCurrencyInput(expenseForm.amount);

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';
    const transactionData = {
      type: 'expense',
      date: expenseForm.date,
      amount: amountVal,
      description: expenseForm.description,
      category: expenseForm.category,
      createdAt: new Date().toISOString()
    };

    try {
        await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'transactions'), transactionData);
        setExpenseForm({ description: '', amount: '', category: 'Reposição de estoque', date: new Date().toISOString().split('T')[0] });
        alert("Despesa registrada!");
    } catch (error) {
        console.error("Erro ao registrar despesa:", error);
    }
  };

  // --- LOADING SCREEN ---
  if (loading) {
    return (
      <div className="min-h-screen bg-slate-950 flex items-center justify-center text-emerald-500">
        <div className="flex flex-col items-center gap-4">
          <Loader2 size={48} className="animate-spin" />
          <p className="text-slate-400 text-sm">Conectando ao Banco de Dados...</p>
        </div>
      </div>
    );
  }

  // --- CÁLCULOS DE DASHBOARD (CORRIGIDOS) ---
  const currentMonthIndex = new Date().getMonth(); // Mês atual (0-11) local
  
  // Filtra por ANO usando a string da data
  const yearTrans = transactions.filter(t => getDateParts(t.date).year === Number(selectedYear));
  
  // Filtra por MÊS usando a string da data (comparando com o mês atual real)
  const monthTrans = yearTrans.filter(t => getDateParts(t.date).month === currentMonthIndex);

  const revenueYear = yearTrans.filter(t => t.type === 'income').reduce((acc, t) => acc + t.amount, 0);
  const expenseYear = yearTrans.filter(t => t.type === 'expense').reduce((acc, t) => acc + t.amount, 0);
  const profitYear = revenueYear - expenseYear;

  const revenueMonth = monthTrans.filter(t => t.type === 'income').reduce((acc, t) => acc + t.amount, 0);
  const expenseMonth = monthTrans.filter(t => t.type === 'expense').reduce((acc, t) => acc + t.amount, 0);
  const profitMonth = revenueMonth - expenseMonth;
  
  // Gráfico Mensal (usando a string de data para agrupar corretamente)
  const chartData = Array.from({ length: 12 }, (_, i) => {
    const monthly = yearTrans.filter(t => getDateParts(t.date).month === i);
    const inc = monthly.filter(t => t.type === 'income').reduce((acc, t) => acc + t.amount, 0);
    const exp = monthly.filter(t => t.type === 'expense').reduce((acc, t) => acc + t.amount, 0);
    const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
    return { name: months[i], Receita: inc, Despesa: exp };
  });

  const getTopProducts = (transactionList) => {
    const salesCount = {};
    transactionList.filter(t => t.type === 'income').forEach(t => {
      if(t.items) {
        t.items.forEach(item => {
          if (!salesCount[item.name]) salesCount[item.name] = 0;
          salesCount[item.name] += item.quantity;
        });
      }
    });
    return Object.entries(salesCount)
      .map(([name, qtd]) => ({ name, qtd }))
      .sort((a, b) => b.qtd - a.qtd)
      .slice(0, 3);
  };

  const top3Month = getTopProducts(monthTrans);
  const top3Year = getTopProducts(yearTrans);

  // --- RENDERIZAÇÃO ---
  return (
    <div className="min-h-screen bg-slate-950 text-slate-200 font-sans selection:bg-emerald-500 selection:text-white">
      
      {/* HEADER */}
      <header className="bg-slate-900 border-b border-slate-800 sticky top-0 z-20">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="bg-emerald-600 p-2 rounded-lg shadow-lg shadow-emerald-900/20">
              <LayoutDashboard className="text-white" size={20} />
            </div>
            <div>
              <h1 className="text-xl font-bold tracking-tight text-white leading-none">Gestão <span className="text-emerald-500">Felizardo</span></h1>
              <p className="text-[10px] text-slate-500 font-medium mt-1 tracking-wider">DARK EDITION • ONLINE</p>
            </div>
          </div>
          
          <div className="flex items-center gap-4">
            <div className="hidden md:flex items-center gap-2 bg-slate-800/50 px-3 py-1.5 rounded-lg border border-slate-700">
                <History size={16} className="text-slate-400" />
                <select 
                    value={selectedYear} 
                    onChange={(e) => setSelectedYear(e.target.value)}
                    className="bg-transparent text-sm text-white font-bold outline-none border-none focus:ring-0 cursor-pointer"
                >
                    {availableYears.map(year => (
                        <option key={year} value={year} className="bg-slate-800">{year}</option>
                    ))}
                </select>
            </div>

            <nav className="flex gap-1 bg-slate-800/50 p-1 rounded-lg overflow-x-auto">
                {['dashboard', 'inventory', 'sales', 'expenses', 'insights'].map(tab => (
                <button 
                    key={tab}
                    onClick={() => setView(tab)}
                    className={`px-4 py-2 rounded-md text-sm font-medium transition-all capitalize whitespace-nowrap ${
                    view === tab 
                    ? 'bg-slate-700 text-white shadow-sm' 
                    : 'text-slate-400 hover:text-white hover:bg-slate-800'
                    }`}
                >
                    {tab === 'dashboard' ? 'Painel' : 
                    tab === 'inventory' ? 'Estoque' : 
                    tab === 'sales' ? 'Entradas' : 
                    tab === 'expenses' ? 'Saídas' : 'Insights'}
                </button>
                ))}
            </nav>
          </div>
        </div>
      </header>

      <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        {/* DASHBOARD */}
        {view === 'dashboard' && (
          <div className="space-y-6 animate-in fade-in duration-500">
            
            <div className="md:hidden flex items-center justify-between bg-slate-900 p-3 rounded-lg border border-slate-800">
                <span className="text-sm text-slate-400 font-medium">Visualizando Ano:</span>
                <select 
                    value={selectedYear} 
                    onChange={(e) => setSelectedYear(e.target.value)}
                    className="bg-slate-800 text-white text-sm font-bold rounded px-2 py-1 outline-none border border-slate-700"
                >
                    {availableYears.map(year => (
                        <option key={year} value={year}>{year}</option>
                    ))}
                </select>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div className="bg-slate-900 p-6 rounded-xl border border-slate-800 shadow-lg relative overflow-hidden">
                <div className="absolute right-0 top-0 p-4 opacity-5"><DollarSign size={80} /></div>
                <p className="text-slate-400 text-xs font-bold uppercase tracking-wider mb-2">Faturamento</p>
                <div className="mb-4">
                    <span className="text-3xl font-bold text-white block">{formatCurrency(revenueMonth)}</span>
                    <span className="text-xs text-emerald-500 font-medium">Mês Atual ({new Date().toLocaleString('pt-BR', { month: 'short' })})</span>
                </div>
                <div className="flex items-center gap-2 pt-4 border-t border-slate-800/50">
                    <div className="bg-slate-800 p-1.5 rounded-md text-emerald-400"><BarChart3 size={16}/></div>
                    <div>
                        <span className="text-xs text-slate-500 block uppercase">Total em {selectedYear}</span>
                        <span className="text-sm font-bold text-slate-300">{formatCurrency(revenueYear)}</span>
                    </div>
                </div>
              </div>

              <div className="bg-slate-900 p-6 rounded-xl border border-slate-800 shadow-lg relative overflow-hidden">
                <div className="absolute right-0 top-0 p-4 opacity-5"><TrendingDown size={80} /></div>
                <p className="text-slate-400 text-xs font-bold uppercase tracking-wider mb-2">Despesas</p>
                <div className="mb-4">
                    <span className="text-3xl font-bold text-white block">{formatCurrency(expenseMonth)}</span>
                    <span className="text-xs text-red-500 font-medium">Mês Atual</span>
                </div>
                <div className="flex items-center gap-2 pt-4 border-t border-slate-800/50">
                    <div className="bg-slate-800 p-1.5 rounded-md text-red-400"><ArrowDownRight size={16}/></div>
                    <div>
                        <span className="text-xs text-slate-500 block uppercase">Total em {selectedYear}</span>
                        <span className="text-sm font-bold text-slate-300">{formatCurrency(expenseYear)}</span>
                    </div>
                </div>
              </div>

              <div className="bg-slate-900 p-6 rounded-xl border border-slate-800 shadow-lg relative overflow-hidden">
                <div className="absolute right-0 top-0 p-4 opacity-5"><ShoppingBag size={80} /></div>
                <p className="text-slate-400 text-xs font-bold uppercase tracking-wider mb-2">Lucro Líquido</p>
                <div className="mb-4">
                    <span className={`text-3xl font-bold block ${profitMonth >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                        {formatCurrency(profitMonth)}
                    </span>
                    <span className="text-xs text-slate-500 font-medium">Mês Atual</span>
                </div>
                <div className="flex items-center gap-2 pt-4 border-t border-slate-800/50">
                    <div className="bg-slate-800 p-1.5 rounded-md text-blue-400"><TrendingUp size={16}/></div>
                    <div>
                        <span className="text-xs text-slate-500 block uppercase">Total em {selectedYear}</span>
                        <span className={`text-sm font-bold ${profitYear >= 0 ? 'text-slate-300' : 'text-red-400'}`}>
                            {formatCurrency(profitYear)}
                        </span>
                    </div>
                </div>
              </div>
            </div>

            <div className="bg-slate-900 p-6 rounded-xl border border-slate-800 shadow-lg">
              <h3 className="text-lg font-bold text-white mb-6 flex items-center gap-2">
                <BarChart3 size={20} className="text-emerald-500"/> Evolução Financeira - {selectedYear}
              </h3>
              <div className="h-96 w-full">
                <ResponsiveContainer width="100%" height="100%">
                  <AreaChart data={chartData} margin={{top: 10, right: 10, left: 0, bottom: 0}}>
                    <defs>
                      <linearGradient id="colorRev" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="5%" stopColor="#10B981" stopOpacity={0.3}/>
                        <stop offset="95%" stopColor="#10B981" stopOpacity={0}/>
                      </linearGradient>
                      <linearGradient id="colorExp" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="5%" stopColor="#EF4444" stopOpacity={0.3}/>
                        <stop offset="95%" stopColor="#EF4444" stopOpacity={0}/>
                      </linearGradient>
                    </defs>
                    <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} />
                    <XAxis dataKey="name" stroke="#94a3b8" tick={{fontSize: 12}} axisLine={false} tickLine={false} dy={10} />
                    <YAxis stroke="#94a3b8" tick={{fontSize: 12}} axisLine={false} tickLine={false} tickFormatter={(val) => `R$${val}`} />
                    <Tooltip 
                      contentStyle={{backgroundColor: '#0f172a', border: '1px solid #1e293b', borderRadius: '8px', color: '#fff'}}
                      formatter={(value) => formatCurrency(value)}
                    />
                    <Legend wrapperStyle={{paddingTop: '20px'}} />
                    <Area type="monotone" name="Receita" dataKey="Receita" stroke="#10B981" strokeWidth={3} fillOpacity={1} fill="url(#colorRev)" />
                    <Area type="monotone" name="Despesa" dataKey="Despesa" stroke="#EF4444" strokeWidth={3} fillOpacity={1} fill="url(#colorExp)" />
                  </AreaChart>
                </ResponsiveContainer>
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="bg-slate-900 p-6 rounded-xl border border-slate-800 shadow-lg">
                    <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <Trophy size={20} className="text-yellow-500"/> Top 3 (Mês Atual)
                    </h3>
                    <div className="space-y-3">
                        {top3Month.length > 0 ? top3Month.map((p, i) => (
                            <div key={i} className="flex justify-between items-center p-3 bg-slate-800/40 rounded-lg border border-slate-700/50">
                                <div className="flex items-center gap-3">
                                    <span className="w-6 h-6 flex items-center justify-center bg-yellow-500/20 text-yellow-500 rounded-full text-xs font-bold">{i+1}</span>
                                    <span className="text-sm text-slate-200 font-medium">{p.name}</span>
                                </div>
                                <span className="text-sm font-bold text-emerald-400">{p.qtd} un.</span>
                            </div>
                        )) : <p className="text-slate-500 text-sm text-center py-4">Sem vendas este mês.</p>}
                    </div>
                </div>

                <div className="bg-slate-900 p-6 rounded-xl border border-slate-800 shadow-lg">
                    <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <Trophy size={20} className="text-blue-500"/> Top 3 ({selectedYear})
                    </h3>
                    <div className="space-y-3">
                        {top3Year.length > 0 ? top3Year.map((p, i) => (
                            <div key={i} className="flex justify-between items-center p-3 bg-slate-800/40 rounded-lg border border-slate-700/50">
                                <div className="flex items-center gap-3">
                                    <span className="w-6 h-6 flex items-center justify-center bg-blue-500/20 text-blue-500 rounded-full text-xs font-bold">{i+1}</span>
                                    <span className="text-sm text-slate-200 font-medium">{p.name}</span>
                                </div>
                                <span className="text-sm font-bold text-blue-400">{p.qtd} un.</span>
                            </div>
                        )) : <p className="text-slate-500 text-sm text-center py-4">Sem vendas em {selectedYear}.</p>}
                    </div>
                </div>
            </div>
          </div>
        )}

        {/* INVENTORY */}
        {view === 'inventory' && (
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 animate-in slide-in-from-right-4 duration-500">
            <div className="bg-slate-900 p-6 rounded-xl border border-slate-800 h-fit sticky top-24">
              <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                <Package size={20} className="text-blue-500"/> Novo Produto
              </h3>
              <form onSubmit={handleAddProduct} className="space-y-4">
                <div>
                  <label className="text-xs font-bold text-slate-500 uppercase">Nome do Item</label>
                  <input required type="text" value={newProd.name} onChange={e => setNewProd({...newProd, name: e.target.value})} className="w-full mt-1 bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-white focus:border-blue-500 outline-none" placeholder="Ex: Caneca Branca"/>
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="text-xs font-bold text-slate-500 uppercase">Custo Mercadoria</label>
                    <input required type="text" value={newProd.merchCost} onChange={e => setNewProd({...newProd, merchCost: e.target.value})} className="w-full mt-1 bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-white focus:border-blue-500 outline-none" placeholder="0,00"/>
                  </div>
                  <div>
                    <label className="text-xs font-bold text-slate-500 uppercase">Custo Produção</label>
                    <input required type="text" value={newProd.prodCost} onChange={e => setNewProd({...newProd, prodCost: e.target.value})} className="w-full mt-1 bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-white focus:border-blue-500 outline-none" placeholder="0,00"/>
                  </div>
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="text-xs font-bold text-slate-500 uppercase">Preço Venda</label>
                    <input required type="text" value={newProd.price} onChange={e => setNewProd({...newProd, price: e.target.value})} className="w-full mt-1 bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-white focus:border-blue-500 outline-none" placeholder="0,00"/>
                  </div>
                  <div>
                    <label className="text-xs font-bold text-slate-500 uppercase">Estoque Inicial</label>
                    <input required type="text" value={newProd.stock} onChange={e => setNewProd({...newProd, stock: e.target.value})} className="w-full mt-1 bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-white focus:border-blue-500 outline-none" placeholder="0"/>
                  </div>
                </div>
                
                {(parseCurrencyInput(newProd.merchCost) || parseCurrencyInput(newProd.prodCost)) > 0 && (
                  <div className="bg-slate-800/50 p-3 rounded-lg text-sm flex justify-between items-center border border-slate-700">
                    <span className="text-slate-400">Custo Total Calculado:</span>
                    <span className="font-bold text-white">{formatCurrency(parseCurrencyInput(newProd.merchCost) + parseCurrencyInput(newProd.prodCost))}</span>
                  </div>
                )}

                <button type="submit" className="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg transition shadow-lg shadow-blue-900/20">
                  Cadastrar (Controle Manual)
                </button>
              </form>
            </div>

            <div className="lg:col-span-2 bg-slate-900 rounded-xl border border-slate-800 overflow-hidden">
              <div className="p-6 border-b border-slate-800">
                <h3 className="font-bold text-white">Catálogo de Produtos</h3>
                <p className="text-xs text-slate-500 mt-1">Gerencie quantidades manualmente aqui. Vendas não alteram este estoque.</p>
              </div>
              <div className="overflow-x-auto">
                <table className="w-full text-left text-sm text-slate-400">
                  <thead className="bg-slate-950 text-slate-500 uppercase font-bold text-xs">
                    <tr>
                      <th className="px-6 py-3">Produto</th>
                      <th className="px-6 py-3">Custos (Merc/Prod)</th>
                      <th className="px-6 py-3">Total</th>
                      <th className="px-6 py-3">Venda</th>
                      <th className="px-6 py-3 text-center">Qtd (Manual)</th>
                      <th className="px-6 py-3"></th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-800">
                    {products.map(p => (
                      <tr key={p.id} className="hover:bg-slate-800/50">
                        <td className="px-6 py-4 font-medium text-white">{p.name}</td>
                        <td className="px-6 py-4 text-xs">
                          <div className="flex flex-col">
                            <span>M: {formatCurrency(p.merchCost)}</span>
                            <span>P: {formatCurrency(p.prodCost)}</span>
                          </div>
                        </td>
                        <td className="px-6 py-4 text-slate-300">{formatCurrency(p.totalCost)}</td>
                        <td className="px-6 py-4 text-emerald-400 font-bold">{formatCurrency(p.price)}</td>
                        <td className="px-6 py-4 text-center">
                          <span className={`px-2 py-1 rounded text-xs font-bold ${p.stock < 5 ? 'bg-red-500/20 text-red-400' : 'bg-slate-700 text-white'}`}>
                            {p.stock}
                          </span>
                        </td>
                        <td className="px-6 py-4 text-right">
                          <button onClick={() => deleteProduct(p.id)} className="text-slate-600 hover:text-red-500 transition"><Trash2 size={16}/></button>
                        </td>
                      </tr>
                    ))}
                    {products.length === 0 && <tr><td colSpan="6" className="px-6 py-8 text-center italic">Nenhum produto cadastrado.</td></tr>}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        )}

        {/* SALES */}
        {view === 'sales' && (
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 animate-in slide-in-from-right-4 duration-500">
            <div className="lg:col-span-2">
              <div className="bg-slate-900 rounded-xl border border-slate-800 overflow-hidden">
                <div className="p-5 bg-emerald-900/10 border-b border-emerald-500/10 flex justify-between items-center">
                  <h3 className="font-bold text-emerald-400 flex items-center gap-2">
                    <ShoppingCart size={20}/> Novo Pedido
                  </h3>
                  <div className="flex items-center gap-2 bg-slate-800 border border-slate-700 rounded-lg px-3 py-1">
                    <Calendar size={14} className="text-slate-400"/>
                    <input 
                        type="date" 
                        value={saleDate} 
                        onChange={e => setSaleDate(e.target.value)}
                        className="bg-transparent text-sm text-white outline-none border-none focus:ring-0"
                    />
                  </div>
                </div>
                
                <div className="p-6 space-y-6">
                  <div className="bg-slate-800/30 p-4 rounded-xl border border-slate-700 grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                    <div className="md:col-span-8">
                      <label className="text-xs font-bold text-slate-500 uppercase">Produto</label>
                      <select 
                        value={cartItem.productId} 
                        onChange={e => setCartItem({...cartItem, productId: e.target.value})}
                        className="w-full mt-1 bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-white outline-none focus:border-emerald-500"
                      >
                        <option value="">Selecione...</option>
                        {products.map(p => (
                          <option key={p.id} value={p.id}>{p.name} (R$ {p.price})</option>
                        ))}
                      </select>
                    </div>
                    <div className="md:col-span-3">
                      <label className="text-xs font-bold text-slate-500 uppercase">Qtd</label>
                      <input type="number" min="1" value={cartItem.quantity} onChange={e => setCartItem({...cartItem, quantity: e.target.value})} className="w-full mt-1 bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-white outline-none focus:border-emerald-500"/>
                    </div>
                    <div className="md:col-span-1">
                      <button onClick={addToCart} disabled={!cartItem.productId} className="w-full bg-emerald-600 hover:bg-emerald-500 disabled:bg-slate-700 disabled:text-slate-500 text-white p-2.5 rounded-lg flex justify-center">
                        <Plus size={20}/>
                      </button>
                    </div>
                  </div>

                  <div className="min-h-[150px]">
                    <h4 className="text-xs font-bold text-slate-500 uppercase mb-3">Itens no Pedido</h4>
                    {cart.length > 0 ? (
                      <div className="space-y-2">
                        {cart.map((item, idx) => (
                          <div key={idx} className="flex justify-between items-center p-3 bg-slate-800 rounded-lg border border-slate-700">
                            <div className="flex items-center gap-3">
                              <span className="bg-slate-700 text-white w-8 h-8 flex items-center justify-center rounded font-bold text-xs">{item.quantity}x</span>
                              <div>
                                <p className="text-white font-medium">{item.name}</p>
                              </div>
                            </div>
                            <div className="flex items-center gap-4">
                              <span className="text-emerald-400 font-bold">{formatCurrency(item.total)}</span>
                              <button onClick={() => setCart(cart.filter((_, i) => i !== idx))} className="text-slate-500 hover:text-red-500"><Trash2 size={16}/></button>
                            </div>
                          </div>
                        ))}
                      </div>
                    ) : (
                      <div className="text-center py-10 text-slate-600 border-2 border-dashed border-slate-800 rounded-xl">
                        Nenhum item adicionado.
                      </div>
                    )}
                  </div>

                  <div className="pt-6 border-t border-slate-800 flex flex-col md:flex-row justify-between items-center gap-4">
                    <div className="w-full md:w-1/2 flex items-center gap-2 bg-slate-900 border border-slate-700 rounded-lg px-3 py-1">
                        <User size={18} className="text-slate-500"/>
                        <input 
                            type="text" 
                            placeholder="Nome do Cliente" 
                            value={customerName}
                            onChange={e => setCustomerName(e.target.value)}
                            className="w-full bg-transparent p-2 text-white outline-none focus:border-none"
                        />
                    </div>
                    <div className="flex items-center gap-4 w-full md:w-auto">
                      <div className="text-right">
                        <p className="text-xs text-slate-500 uppercase">Total Geral</p>
                        <p className="text-2xl font-bold text-white">{formatCurrency(cart.reduce((acc, i) => acc + i.total, 0))}</p>
                      </div>
                      <button 
                        onClick={finalizeSale}
                        disabled={cart.length === 0}
                        className="bg-emerald-600 hover:bg-emerald-500 disabled:bg-slate-800 disabled:text-slate-600 text-white px-6 py-3 rounded-lg font-bold shadow-lg shadow-emerald-900/20 flex items-center gap-2"
                      >
                        <Save size={20}/> Finalizar
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div className="lg:col-span-1 bg-slate-900 rounded-xl border border-slate-800 p-6 h-fit">
              <h3 className="font-bold text-white mb-4">Últimas Vendas</h3>
              <div className="space-y-4 max-h-[500px] overflow-y-auto pr-2 custom-scrollbar">
                {transactions.filter(t => t.type === 'income').map(t => (
                  <div key={t.id} className="border-b border-slate-800 pb-4 last:border-0">
                    <div className="flex justify-between items-start mb-2">
                      <div>
                        <p className="font-bold text-emerald-400 text-sm">{t.description}</p>
                        <p className="text-xs text-slate-500">{new Date(t.date).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</p>
                      </div>
                      <span className="text-white font-bold text-sm">{formatCurrency(t.amount)}</span>
                    </div>
                    {t.items && (
                      <div className="text-xs text-slate-500 bg-slate-800/50 p-2 rounded border border-slate-700/50">
                        {t.items.map((i, idx) => (
                          <p key={idx} className="truncate">• {i.quantity}x {i.name}</p>
                        ))}
                      </div>
                    )}
                  </div>
                ))}
                {transactions.filter(t => t.type === 'income').length === 0 && <p className="text-slate-500 text-sm italic">Sem histórico.</p>}
              </div>
            </div>
          </div>
        )}

        {/* EXPENSES */}
        {view === 'expenses' && (
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6 animate-in slide-in-from-right-4 duration-500">
            <div className="bg-slate-900 p-6 rounded-xl border border-slate-800 h-fit">
              <h3 className="font-bold text-white mb-6 flex items-center gap-2 text-red-400">
                <TrendingDown size={20}/> Registrar Despesa
              </h3>
              <form onSubmit={addExpense} className="space-y-4">
                <div>
                  <label className="text-xs font-bold text-slate-500 uppercase">Descrição</label>
                  <input required type="text" value={expenseForm.description} onChange={e => setExpenseForm({...expenseForm, description: e.target.value})} className="w-full mt-1 bg-slate-800 border border-slate-700 rounded-lg p-3 text-white outline-none focus:border-red-500" placeholder="Ex: Conta de Luz"/>
                </div>
                <div>
                  <label className="text-xs font-bold text-slate-500 uppercase">Categoria</label>
                  <select value={expenseForm.category} onChange={e => setExpenseForm({...expenseForm, category: e.target.value})} className="w-full mt-1 bg-slate-800 border border-slate-700 rounded-lg p-3 text-white outline-none focus:border-red-500">
                    <option>Reposição de estoque</option>
                    <option>Novos produtos</option>
                    <option>Marketing - Anúncios</option>
                    <option>Imposto - DAS</option>
                    <option>Site</option>
                    <option>Aplicativos</option>
                    <option>Outros</option>
                  </select>
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="text-xs font-bold text-slate-500 uppercase">Valor</label>
                    <input required type="text" value={expenseForm.amount} onChange={e => setExpenseForm({...expenseForm, amount: e.target.value})} className="w-full mt-1 bg-slate-800 border border-slate-700 rounded-lg p-3 text-white outline-none focus:border-red-500" placeholder="0,00"/>
                  </div>
                  <div>
                    <label className="text-xs font-bold text-slate-500 uppercase">Data</label>
                    <input required type="date" value={expenseForm.date} onChange={e => setExpenseForm({...expenseForm, date: e.target.value})} className="w-full mt-1 bg-slate-800 border border-slate-700 rounded-lg p-3 text-white outline-none focus:border-red-500"/>
                  </div>
                </div>
                <button className="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-3 rounded-lg mt-4 shadow-lg shadow-red-900/20">
                  Registrar Saída
                </button>
              </form>
            </div>

            <div className="bg-slate-900 p-6 rounded-xl border border-slate-800">
              <h3 className="font-bold text-white mb-4">Histórico de Despesas</h3>
              <div className="overflow-x-auto">
                <table className="w-full text-left text-sm text-slate-400">
                  <thead className="bg-slate-950 text-slate-500 uppercase font-bold text-xs">
                    <tr>
                      <th className="px-4 py-3">Data</th>
                      <th className="px-4 py-3">Descrição</th>
                      <th className="px-4 py-3">Cat.</th>
                      <th className="px-4 py-3 text-right">Valor</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-800">
                    {transactions.filter(t => t.type === 'expense').map(t => (
                      <tr key={t.id} className="hover:bg-slate-800/50">
                        <td className="px-4 py-3">{new Date(t.date).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</td>
                        <td className="px-4 py-3 font-medium text-slate-300">{t.description}</td>
                        <td className="px-4 py-3"><span className="bg-slate-800 px-2 py-1 rounded text-xs">{t.category}</span></td>
                        <td className="px-4 py-3 text-right text-red-400 font-bold">{formatCurrency(t.amount)}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        )}

        {/* INSIGHTS */}
        {view === 'insights' && (
          <div className="space-y-6 animate-in fade-in duration-500">
             <div className="bg-slate-900 p-6 rounded-xl border border-slate-800">
                <div className="flex items-center gap-2 mb-4">
                    <Lightbulb size={24} className="text-yellow-400"/>
                    <h3 className="text-lg font-bold text-white">Central de Estratégia</h3>
                </div>
                <p className="text-slate-400">Use as métricas do painel principal para ajustar suas campanhas. Fique de olho no Top 3 Mensal para saber o que repor!</p>
             </div>
          </div>
        )}

      </main>
    </div>
  );
};

export default FinancialManagerDark;
